async function getSavedKey(){try{self.irisKey=await localforage.getItem("swIrisKey")}catch(e){console.error("error loading iris key",e)}return self.irisKey}function getOpenClient(e){return new Promise((t=>{e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((function(e){for(var i=0;i<e.length;i++){var n=e[i];if(n.url===urlToOpen&&"focus"in n)return t(n)}t(null)})))}))}self.importScripts("./gun.js"),self.importScripts("./sea.js"),self.importScripts("./localforage.min.js");const urlToOpen=new URL("/",self.location.origin).href;var CACHE_NAME="iris-messenger-cache-v1";0!==self.location.host.indexOf("localhost")&&self.addEventListener("fetch",(function(e){e.request&&"GET"!==e.request.method||e.respondWith(caches.open(CACHE_NAME).then((function(t){return t.match(e.request).then((function(i){var n=fetch(e.request).then((function(i){return t.put(e.request,i.clone()),i}));return i||n}))})))})),self.onmessage=function(e){e.data.hasOwnProperty("key")&&(self.irisKey=e.data.key,localforage.setItem("swIrisKey",self.irisKey))},self.addEventListener("push",(async e=>{const t=await getOpenClient(e);if(t&&"visible"===t.visibilityState)return;self.irisKey||await getSavedKey();const i=e.data.json();if(i.title&&i.body||console.log("what?",i),self.irisKey&&i.from&&i.from.epub){const e=await Gun.SEA.secret(i.from.epub,self.irisKey);i.title=await Gun.SEA.decrypt(i.title,e),i.body=await Gun.SEA.decrypt(i.body,e)}i.title&&0===i.title.indexOf("SEA{")&&(i.title="",i.body="Encrypted message"),self.registration.showNotification(i.title||"No title",{body:i.body||"No text",icon:"./img/icon128.png"})})),self.addEventListener("notificationclick",(async function(e){e.notification.close();const t=await getOpenClient(e);t?t.focus():clients.openWindow&&clients.openWindow(urlToOpen)}));